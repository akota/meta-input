/**
 * Meta Input
 * @link http://github.com/jakulov/meta_input
 * @author Yakov Akulov
 * @email jakulov@gmail.com
 * @param options
 * @returns {jQuery}
 */
!function(t){t.fn.meta_input=function(e){if(this.options=t.extend({multiple:!1,ajax:"",match:["name"],matchFirst:!1,filterSame:!0,limit:100,inputTimeout:400,select:!1,suggestTemplate:"{{name}}",customValues:!1,selectPlaceholder:"Type to filter",data:[],value:null},e),this.length>1)return this.each(function(){t(this).meta_input(e)}),this;this._init=function(){s.options.required&&s._input.prop("required",!0),s.options.select&&(s._wrap.find(".mi-input").append('<div class="dropdown">'),s._wrap.find(".dropdown").on("click",function(t){s._wrap.find(".mi-suggest").is(":visible")?(s._input.blur(),s.closeSuggest()):(s._input.focus(),t.stopPropagation(),t.preventDefault())}),s._input.on("click",function(t){t.stopPropagation(),t.preventDefault()})),s._wrap.find("tr").prepend('<td class="mi-selected">'),s._wrap.find(".mi-input").append(t('<div class="mi-suggest">')),s._resetStyle(),s.setValue(s.options.value),s._input.on("keypress",function(){s.requestTimeout&&window.clearTimeout(s.requestTimeout),s.requestTimeout=window.setTimeout(function(){s.showSuggest()},400)}),s._input.on("keydown",function(e){40==e.keyCode||38==e.keyCode?(e.stopPropagation(),e.preventDefault(),s.navigate(40==e.keyCode)):27==e.keyCode?s.closeSuggest():13==e.keyCode?s.selectItem():8==e.keyCode&&(t(this).val()||s.removeSelected(),t(this).val().length<=1&&!s.options.select&&s.closeSuggest(),t(this).val().length>1&&(s.requestTimeout&&window.clearTimeout(s.requestTimeout),s.requestTimeout=window.setTimeout(function(){s.showSuggest()},400)))}),s._input.on("focus",function(e){s.options.select&&(t(this).attr("placeholder",s.options.selectPlaceholder),s.showSuggest(),e.stopPropagation(),e.preventDefault())}),s._wrap.on("mouseover",".mi-si",function(){s._wrap.find(".mi-si").removeClass("active"),t(this).addClass("active")}),s._wrap.on("click",".mi-si",function(){s.selectItem(),s.options.multiple&&s._input.focus()}),s._wrap.on("click",".mi-sg-rm",function(){t(this).closest(".mi-sg").remove(),s._input.focus(),s._fixWidth()}),t("body").on("click",function(){s.closeSuggest()})},this._resetStyle=function(){s._input.css("display","block").css("border","none").css("outline","none").css("box-shadow","none")},this.showSuggest=function(){var t=s._input.val().toLocaleLowerCase();(t||s.options.select)&&(s.termCache[t]?s._displayTermData(s.termCache[t]):s._requestTermData(t))},this.selectItem=function(){var t=s._wrap.find(".mi-si.active");t.length?(s.options.multiple||s.removeSelected(),s._addValueItem(t.data("id"),t.data("label")),s._input.val(""),s.closeSuggest(),s.options.multiple||s._input.blur(),s.options.select&&s._input.attr("placeholder","")):s.options.customValues&&s._input.val()&&(s.options.multiple||s.removeSelected(),s._addValueItem(s._input.val(),s._input.val()),s._input.val(""),s.closeSuggest(),s.options.multiple||s._input.blur())},this._addValueItem=function(e,i){var n=t('<div class="mi-sg" id="'+s._getValueItemId(1)+'"><div class="mi-sg-label">'+i+'</div><div class="mi-sg-rm">&times;</div><input type="hidden" name="'+s._name+'" value="'+e+'"></div>');s._wrap.find(".mi-selected").append(n),s._fixWidth()},this._getValueItemId=function(t){var e=s._wrap.find(".mi-sg").length;return t&&(e+=1),s._name.replace(/\[\]/,"__")+"_"+e},this.removeSelected=function(){s._wrap.find(".mi-sg:last").remove(),s._fixWidth()},this.setValue=function(e){s.options.value=e?e:s.options.value,s.options.value||(s.options.value=s._input.val()),s._input.val(""),s.options.value&&(Array.isArray(s.options.value)?t.each(s.options.value,function(t){var e=s.options.value[t];"string"==typeof e?s._addValueItem(e,e):s._addValueItem(e.id,e.name)}):"string"==typeof s.options.value?s._addValueItem(s.options.value,s.options.value):s._addValueItem(s.options.value.id,s.options.value.name))},this.getValue=function(){if(s.options.multiple){var e=[];return s._wrap.find(".mi-selected").find("input[type=hidden]").each(function(){e.push(t(this).val())}),e}return s._wrap.find(".mi-selected").find("input[type=hidden]").val()},this._isItemSelected=function(t){var e=!s.options.filterSame;if(s.options.filterSame){var i=s.getValue();i&&(e=s.options.multiple?-1!==i.indexOf(t.id):i==t.id)}return e},this._displayTermData=function(e){var i=t('<div class="mi-suggest-items">');t.each(e,function(n){var a=e[n];if(!s._isItemSelected(a)){var o=t('<div class="mi-si" data-id="'+a.id+'" data-label="'+a.name+'"></div>'),u=s.options.suggestTemplate;for(var l in a)a.hasOwnProperty(l)&&(u=u.replace("{{"+l+"}}",a[l]));o.html(u),i.append(o)}}),e&&(s._wrap.find(".mi-suggest").html(i).show(),s._fixWidth(),s.options.customValues||s.navigate(1))},this._fixWidth=function(){var e=0,i=s._wrap.width()/3*2;s._wrap.find(".mi-sg").each(function(){e+=t(this).width()+5}),e>i&&(e=i),s._wrap.find(".mi-selected").css("width",e+"px");var n=s._input.width()+24;s._wrap.find(".mi-suggest").css("width",n+"px")},this.navigate=function(t){var e=s._wrap.find(".mi-si.active"),i=null;if(i=t?e.length?e.next(".mi-si"):s._wrap.find(".mi-si:first"):e.length?e.prev(".mi-si"):s._wrap.find(".mi-si:last"),s._wrap.find(".mi-si").removeClass("active"),i.addClass("active"),i.length){var n=s._wrap.find(".mi-suggest");n.scrollTop(n.scrollTop()+i.position().top)}},this.closeSuggest=function(){s._wrap.find(".mi-suggest").html("").hide()},this._requestTermData=function(e){if(s.options.ajax)t.getJSON(s.options.ajax,{term:e},function(t){t&&t.data&&s._displayTermData(t.data)});else{for(var i=0,n=[],a=0;a<s.options.data.length;a++){var o=s.options.data[a];if((!e||s._matchItem(o,e))&&(n.push("string"==typeof o?{id:o,name:o}:o),i++,i>=s.options.limit))break}s._displayTermData(n)}},this._matchItem=function(e,i){if("string"!=typeof e){var n=!1;return t.each(this.options.match,function(t,a){var o=e[a]?e[a].toLocaleLowerCase().indexOf(i):-1;(s.options.matchFirst&&0===o||!s.options.matchFirst&&-1!==o)&&(n=!0)}),n}var a=e.toLocaleLowerCase().indexOf(i);return s.options.matchFirst&&0===a||!s.options.matchFirst&&-1!==a?!0:void 0},this._getSelectData=function(e){var i=[],s=e.find("option:first").attr("value");return e.find("option").each("undefined"!=typeof s&&s!==!1?function(){i.push({id:t(this).attr("value"),name:t(this).text()})}:function(){i.push(t(this).text())}),i},this._getSelectValue=function(e){var i=[],s=e.find("option:first").attr("value");return e.find("option:selected").each("undefined"!=typeof s&&s!==!1?function(){i.push({id:t(this).attr("value"),name:t(this).text()})}:function(){i.push(t(this).text())}),i},this._name=this.attr("name"),"SELECT"===this.prop("tagName")?(this.options.data=this._getSelectData(this),this.options.value||(this.options.value=this._getSelectValue(this)),this.prop("multiple")&&(this.options.multiple=!0),this._input=t('<input type="text" name="'+this._name+'" class="'+this.attr("class")+'" placeholder="">'),this.css("display","none").removeAttr("name"),this._input.insertAfter(this),this.options.select=!0,this.options.customValues=!1):this._input=this;var i='<div class="mi-wrap"><table><tr><td class="mi-input"></td></tr></table></div>';this._input.wrap(t(i)),this._wrap=this._input.closest(".mi-wrap"),this.termCache={},this.requestTimeout=null;var s=this;return this._init(),this}}(jQuery);