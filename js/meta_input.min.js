/**
 * Meta Input
 * @link http://github.com/jakulov/meta_input
 * @author Yakov Akulov
 * @email jakulov@gmail.com
 * @param options
 * @returns {jQuery}
 */
!function(t){t.fn.meta_input=function(i){if(this.options=t.extend({multiple:!1,ajax:"",match:["name"],matchFirst:!1,filterSame:!0,limit:100,inputTimeout:400,select:!1,suggestTemplate:"{{name}}",customValues:!1,selectPlaceholder:"Type to filter",data:[],value:null},i),this.length>1)return this.each(function(){t(this).meta_input(i)}),this;this._init=function(){s.options.select&&(s._wrap.find(".mi-input").append('<div class="dropdown">'),s._wrap.find(".dropdown").on("click",function(t){s._wrap.find(".mi-suggest").is(":visible")?(s._input.blur(),s.closeSuggest()):(s._input.focus(),t.stopPropagation(),t.preventDefault())}),s._input.on("click",function(t){t.stopPropagation(),t.preventDefault()})),s._wrap.find("tr").prepend('<td class="mi-selected">'),s._wrap.find(".mi-input").append(t('<div class="mi-suggest">')),s._resetStyle(),s.setValue(s.options.value),s._input.on("keypress",function(){s.requestTimeout&&window.clearTimeout(s.requestTimeout),s.requestTimeout=window.setTimeout(function(){s.showSuggest()},s.options.inputTimeout)}),s._input.on("keydown",function(i){40==i.keyCode||38==i.keyCode?(i.stopPropagation(),i.preventDefault(),s.navigate(40==i.keyCode)):27==i.keyCode?s.closeSuggest():13==i.keyCode?s.selectItem():8==i.keyCode&&(t(this).val()||s.removeSelected(),t(this).val().length<=1&&!s.options.select&&s.closeSuggest(),t(this).val().length>1&&(s.requestTimeout&&window.clearTimeout(s.requestTimeout),s.requestTimeout=window.setTimeout(function(){s.showSuggest()},s.options.inputTimeout)))}),s._input.on("focus",function(i){s.options.select&&(t(this).attr("placeholder",s.options.selectPlaceholder),s.showSuggest(),i.stopPropagation(),i.preventDefault())}),s._wrap.on("mouseover",".mi-si",function(){s._wrap.find(".mi-si").removeClass("active"),t(this).addClass("active")}),s._wrap.on("click",".mi-si",function(){s.selectItem(),s.options.multiple&&s._input.focus()}),s._wrap.on("click",".mi-sg-rm",function(){t(this).closest(".mi-sg").remove(),s._input.focus(),s._fixWidth()}),t("body").on("click",function(){s.closeSuggest()})},this._resetStyle=function(){s._input.css("display","block").css("border","none").css("outline","none").css("box-shadow","none")},this.showSuggest=function(){var t=s._input.val().toLocaleLowerCase();(t||s.options.select)&&(s.termCache[t]?s._displayTermData(s.termCache[t]):s._requestTermData(t))},this.selectItem=function(){var t=s._wrap.find(".mi-si.active");t.length?(s.options.multiple||s.removeSelected(),s._addValueItem(t.data("id"),t.data("label")),s._input.val(""),s.closeSuggest(),s.options.multiple||s._input.blur(),s.options.select&&s._input.attr("placeholder","")):s.options.customValues&&s._input.val()&&(s.options.multiple||s.removeSelected(),s._addValueItem(s._input.val(),s._input.val()),s._input.val(""),s.closeSuggest(),s.options.multiple||s._input.blur())},this._addValueItem=function(i,e){var n=t('<div class="mi-sg"><div class="mi-sg-label">'+e+'</div><div class="mi-sg-rm">&times;</div><input type="hidden" name="'+s._name+'" value="'+i+'"></div>');s._wrap.find(".mi-selected").append(n),s._fixWidth()},this.removeSelected=function(){s._wrap.find(".mi-sg:last").remove(),s._fixWidth()},this.setValue=function(i){s.options.value=i?i:s.options.value,s.options.value||(s.options.value=s._input.val()),s._input.val(""),s.options.value&&(Array.isArray(s.options.value)?t.each(s.options.value,function(t){var i=s.options.value[t];"string"==typeof i?s._addValueItem(i,i):s._addValueItem(i.id,i.name)}):"string"==typeof s.options.value?s._addValueItem(s.options.value,s.options.value):s._addValueItem(s.options.value.id,s.options.value.name))},this.getValue=function(){if(s.options.multiple){var i=[];return s._wrap.find(".mi-selected").find("input[type=hidden]").each(function(){i.push(t(this).val())}),i}return s._wrap.find(".mi-selected").find("input[type=hidden]").val()},this._isItemSelected=function(t){var i=!s.options.filterSame;if(s.options.filterSame){var e=s.getValue();e&&(i=s.options.multiple?-1!==e.indexOf(t.id):e==t.id)}return i},this._displayTermData=function(i){var e=t('<div class="mi-suggest-items">');t.each(i,function(n){var a=i[n];if(!s._isItemSelected(a)){var o=t('<div class="mi-si" data-id="'+a.id+'" data-label="'+a.name+'"></div>'),u=s.options.suggestTemplate;for(var l in a)a.hasOwnProperty(l)&&(u=u.replace("{{"+l+"}}",a[l]));o.html(u),e.append(o)}}),i&&(s._wrap.find(".mi-suggest").html(e).show(),s._fixWidth(),s.options.customValues||s.navigate(1))},this._fixWidth=function(){var i=0,e=s._wrap.width()/3*2;s._wrap.find(".mi-sg").each(function(){i+=t(this).width()+5}),i>e&&(i=e),s._wrap.find(".mi-selected").css("width",i+"px");var n=s._input.width()+24;s._wrap.find(".mi-suggest").css("width",n+"px")},this.navigate=function(t){var i=s._wrap.find(".mi-si.active"),e=null;if(e=t?i.length?i.next(".mi-si"):s._wrap.find(".mi-si:first"):i.length?i.prev(".mi-si"):s._wrap.find(".mi-si:last"),s._wrap.find(".mi-si").removeClass("active"),e.addClass("active"),e.length){var n=s._wrap.find(".mi-suggest");n.scrollTop(n.scrollTop()+e.position().top)}},this.closeSuggest=function(){s._wrap.find(".mi-suggest").html("").hide()},this._requestTermData=function(i){if(s.options.ajax)t.getJSON(s.options.ajax,{term:i},function(t){t&&t.data&&(s.termCache[i]=t.data,s._displayTermData(t.data))});else{for(var e=0,n=[],a=0;a<s.options.data.length;a++){var o=s.options.data[a];if((!i||s._matchItem(o,i))&&(n.push("string"==typeof o?{id:o,name:o}:o),e++,e>=s.options.limit))break}s.termCache[i]=n,s._displayTermData(n)}},this._matchItem=function(i,e){if("string"!=typeof i){var n=!1;return t.each(this.options.match,function(t,a){var o=i[a]?i[a].toLocaleLowerCase().indexOf(e):-1;(s.options.matchFirst&&0===o||!s.options.matchFirst&&-1!==o)&&(n=!0)}),n}var a=i.toLocaleLowerCase().indexOf(e);return s.options.matchFirst&&0===a||!s.options.matchFirst&&-1!==a?!0:void 0},this._getSelectData=function(i){var e=[],s=i.find("option:first").attr("value");return i.find("option").each("undefined"!=typeof s&&s!==!1?function(){e.push({id:t(this).attr("value"),name:t(this).text()})}:function(){e.push(t(this).text())}),e},this._getSelectValue=function(i){var e=[],s=i.find("option:first").attr("value");return i.find("option:selected").each("undefined"!=typeof s&&s!==!1?function(){e.push({id:t(this).attr("value"),name:t(this).text()})}:function(){e.push(t(this).text())}),e},this._name=this.attr("name"),"SELECT"===this.prop("tagName")?(this.options.data=this._getSelectData(this),this.options.value||(this.options.value=this._getSelectValue(this)),this.prop("multiple")&&(this.options.multiple=!0),this._input=t('<input type="text" name="'+this._name+'" class="'+this.attr("class")+'" placeholder="">'),this.css("display","none").removeAttr("name"),this._input.insertAfter(this),this.options.select=!0,this.options.customValues=!1):this._input=this;var e='<div class="mi-wrap"><table><tr><td class="mi-input"></td></tr></table></div>';this._input.wrap(t(e)),this._wrap=this._input.closest(".mi-wrap"),this.termCache={},this.requestTimeout=null;var s=this;return this._init(),this}}(jQuery);